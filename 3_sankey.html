<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>
    .node rect {
        cursor: move;
        fill-opacity: .9;
        shape-rendering: crispEdges;
    }

    .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
    }

    .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
    }

    .link:hover {
        stroke-opacity: .5;
    }

    .wrapper {
        margin-top: 150px;
        margin-left: 50px;
    }

    .row {
        display: flex;
    }

    .column {
        flex: 50%;
    }
</style>

<body>

    <script src="d3/d3.v4.min.js"></script>
    <script src="sankey.js"></script>
    <div class="wrapper">
        <div class="row">
            <div class="column">
                <button id="reset">Reset</button>
                <p id="sankey"></p>
            </div>
            <div class="column">
                <h1>Female Immigrants Origins and Asian Region Destinations, 2020</h1>
                <h2 id="region">Overview</h2>
                <h3>Where are they from and where do they go?</h3>

                Migration often takes place within regions
                In 2020, nearly half of all international migrants at the global level were living in their region of
                origin.
            </div>
        </div>
    </div>
    <script>
        var units = "Immigrants";
        var sources = [];
        var targets = [];

        // set the dimensions and margins of the graph
        var margin = { top: 50, right: 50, bottom: 50, left: 50 },
            width = 800 - margin.left - margin.right,
            height = 700 - margin.top - margin.bottom;

        // format variables
        var formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function (d) { return formatNumber(d) + " " + units; },
            color = d3.scaleOrdinal(d3.schemeCategory10);

        loadData()
        function loadData(nodeName = "All") {
            d3.select("svg").remove();
            // append the svg object to the body of the page
            var svg = d3.select("p").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // Set the sankey diagram properties
            var sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .size([width, height]);

            var path = sankey.link();

            d3.csv("/data/c.csv", function (error, data) {
                var filteredData;
                if (nodeName == "All") {
                    filteredData = data;
                } else {
                    if (sources.includes(nodeName)) {
                        filteredData = data.filter(function (row) {
                            return row['source'] == nodeName;
                        });
                        d3.select("#region").html("Origin: " + nodeName);
                    }
                    if (targets.includes(nodeName)) {
                        filteredData = data.filter(function (row) {
                            return row['target'] == nodeName;
                        });
                        d3.select("#region").html("Destination: " + nodeName);
                    }
                }
                //set up graph in same style as original example but empty
                graph = { "nodes": [], "links": [] };

                filteredData.forEach(function (d) {
                    if (d.value != 0) {
                        if (!sources.includes(d.source)) sources.push(d.source);
                        if (!targets.includes(d.target)) targets.push(d.target);
                        graph.nodes.push({ "name": d.source });
                        graph.nodes.push({ "name": d.target });

                        graph.links.push({
                            "source": d.source,
                            "target": d.target,
                            "value": +d.value
                        });
                    }
                });

                // return only the distinct / unique nodes
                graph.nodes = d3.keys(d3.nest()
                    .key(function (d) { return d.name; })
                    .object(graph.nodes));

                // loop through each link replacing the text with its index from node
                graph.links.forEach(function (d, i) {
                    graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
                    graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
                });

                // now loop through each nodes to make nodes an array of objects
                // rather than an array of strings
                graph.nodes.forEach(function (d, i) {
                    graph.nodes[i] = { "name": d };
                });

                sankey
                    .nodes(graph.nodes)
                    .links(graph.links)
                    .layout(32);

                // add in the links
                var link = svg.append("g").selectAll(".link")
                    .data(graph.links)
                    .enter().append("path")
                    .attr("class", "link")
                    .attr("d", path)
                    .style("stroke-width", function (d) { return Math.max(1, d.dy); })
                    .sort(function (a, b) { return b.dy - a.dy; });

                // add the link titles
                link.append("title")
                    .text(function (d) {
                        return d.source.name + " â†’ " +
                            d.target.name + "\n" + format(d.value);
                    });

                // add in the nodes
                var node = svg.append("g").selectAll(".node")
                    .data(graph.nodes)
                    .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })
                    .on("click", function (d) {
                        loadData(d.name);
                        if (d3.event.defaultPrevented) return;
                    })
                    .call(d3.drag()
                        .subject(function (d) {
                            return d;
                        })
                        .on("start", function () {
                            // this.parentNode.appendChild(this); // this line will make onclick not work
                        })
                        .on("drag", dragmove));

                // add the rectangles for the nodes
                node.append("rect")
                    .attr("height", function (d) { return d.dy; })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function (d) {
                        return d.color = color(d.name.replace(/ .*/, ""));
                    })
                    .style("stroke", function (d) {
                        return d3.rgb(d.color).darker(2);
                    })
                    .append("title")
                    .text(function (d) {
                        return d.name + "\n" + format(d.value);
                    });

                // add in the title for the nodes
                node.append("text")
                    .attr("x", -6)
                    .attr("y", function (d) { return d.dy / 2; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "end")
                    .attr("transform", null)
                    .text(function (d) { return d.name; })
                    .filter(function (d) { return d.x < width / 2; })
                    .attr("x", 6 + sankey.nodeWidth())
                    .attr("text-anchor", "start");

                // the function for moving the nodes
                function dragmove(d) {
                    d3.select(this)
                        .attr("transform",
                            "translate("
                            + d.x + ","
                            + (d.y = Math.max(
                                0, Math.min(height - d.dy, d3.event.y))
                            ) + ")");
                    sankey.relayout();
                    link.attr("d", path);
                }
            });
        }
        document.getElementById("reset").onclick = function () {
            loadData("All");
            d3.select("#region").html("Overview");
        };
    </script>

</body>